# Docker

## CAP_MKNOD_container.sh

### 1. Overview

The **Docker-side script** is intended to run **inside** a privileged or capability-extended Docker container that has:

- `CAP_MKNOD`, allowing it to create special device nodes (e.g., block devices).
- The ability to run as `root` inside the container.

By creating a device node that references the **host**’s actual disk (by specifying **major/minor** numbers), the container can expose that disk to the **unprivileged** user on the **host**—if the host user’s UID overlaps with a container user’s UID.

Once that device node is created (say, `/HARDDISK`) and made world-readable/writable (e.g., `chmod 777 /HARDDISK`), an unprivileged host user (with matching UID) can see it via `/proc/<container-pid>/root/HARDDISK` and effectively read/write the host’s raw disk or partition.

### 2. Why This Works

- **Linux Capabilities**: With `CAP_MKNOD`, a process can create new device nodes (special files). Normally, unprivileged containers can’t do this.  
- **UID Overlap**: If the container user’s UID matches a real user’s UID on the host, that host user can see and manipulate `/proc/<container-pid>/root/*`, including any device nodes created in the container.  
- **Block Device Node**: Pointing the device node at the **real** host disk (e.g., `/dev/sda`) or partition effectively grants raw read/write access to that disk, bypassing file permissions.

### 3. Finding the Correct Major/Minor Numbers

On the **host**, run commands like:

```bash
lsblk -o NAME,MAJ:MIN,FSTYPE,SIZE,MOUNTPOINT
```
or
```bash
fdisk -l
```
to identify the **ext4** partition or entire disk you want. For example, if `/dev/sda1` is `8:1`, then **major=8** and **minor=1**.

To manually exploit this: Inside the container, you can create a device node like this:
```bash
mknod /HARDDISK b 8 1
chmod 777 /HARDDISK
```
This creates a block device node that references `/dev/sda1` (major=8, minor=1) from the host’s perspective—assuming the container can see that device mapping.

### 4. Script Usage

For automatic exploitation you can use the script like this:

```bash
./CAP_MKNOD_container.sh <MAJOR> <MINOR> <HOST_UID> <USERNAME>"
```

##### **Parameters:**
- **MAJOR**: Major device number of the block device (e.g., `259`).
- **MINOR**: Minor device number of the block device (e.g., `2`).
- **HOST_UID**: UID of the user on the host system (e.g., `1002`).
- **USERNAME**: Name of the user to create or use inside the container (e.g., `useronhost`).

---

##### **Detailed Behavior:**
- **Step 1**: Verifies `CAP_MKNOD` is available inside the container.
   - **Step 2**: Creates the block device `/HARDDISK` with major `259` and minor `1`.
   - **Step 3**: Ensures a user with `HOST_UID`  exists:
     - If `HOST_UID` is already associated with a user (e.g., `existinguser`), the script reuses `existinguser`.
     - If `HOST_UID` is not associated with any user, the script creates `useronhost` with `HOST_UID`.
   - **Step 4**: Starts a background process (`sleep 600`) as the specified user.

---

## CAP_MKNOD_host.sh

### 1. Overview

The **Host-side script** is run on the **host** as an **unprivileged** user whose **UID** overlaps with the container’s user. This script:

1. Identifies the correct **container** PID that has the block device node (e.g., `/HARDDISK`).  
2. Uses `debugfs` to read or modify files on that partition from the **host** perspective.  
3. Reads `/etc/shadow`, enumerates `.txt` files in home directories, reads SSH keys, etc.  
4. Optionally (with a the `--brave`) creates a **root-owned** setuid shell trough the device node via debugfs `-w`. WARNING: this can potentially corrupt the file system.

### 2. Why This Works

- **`/proc/<pid>/root`**: If you share a UID with the container’s user, you can access that container user’s mount namespace through `/proc/<pid>/root`.  
- **`debugfs`** or raw block device writes: The host user can run `debugfs` (or `dd`) on `/proc/<pid>/root/HARDDISK` to bypass normal filesystem permissions.  
- **Ext4 Partition**: As long as the filesystem in question is ext2/3/4, `debugfs` can manipulate inode fields (permissions, ownership, etc.), read or write data, or even forcibly set a file’s mode to setuid root.

### 3. Finding Major/Minor (Again)

Usually, you’ve already done this on the **host** to figure out which partition the container references. The **host** script just uses the **`/proc/<pid>/root/HARDDISK`** path that was created inside the container. The container script is what picks the correct **major/minor** to expose.

If you need to confirm again on the host:

```bash
lsblk -o NAME,MAJ:MIN,FSTYPE,SIZE,MOUNTPOINT
```
Pick the block device used by the container. This is how you discovered `8:1` or `253:0` etc. in the first place.

## 4. Script Usage

Example usage:

```bash
#### Basic read
./CAP_MKNOD_host.sh "sleep 600" "/HARDDISK"

#### Potentially destructive: create SUID root shell
./CAP_MKNOD_host.sh "sleep 600" "/HARDDISK" --brave
```

- The **`sleep 600`** is the container process name to search for.  
- **`/HARDDISK`** is the device node name the container script created.  
- `--brave` (or similar) indicates you want to do extremely destructive actions (like setuid bash creation).


